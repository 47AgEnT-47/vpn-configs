name: vpn-checker
on:
  repository_dispatch:
    types: [vpn-checker]
  workflow_dispatch:           
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Prepare Proxy List
        id: prepare
        run: |
          > temp.txt
          # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–ª (–±–∞–∑–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
          > seen_bodies.txt

          while IFS= read -r url || [ -n "$url" ]; do 
            [[ $url == http* ]] || continue
  
            if ! curl -sL --max-time 30 "$url" > current_source.txt; then
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: $url"
              continue
            fi

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å —É—á–µ—Ç–æ–º –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            python3 -c "
            import sys
            protocols = ('vless://', 'vmess://', 'trojan://', 'hysteria', 'hysteria2', 'tuic')
            
            try:
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–∞–∑—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—Ç–µ–ª–∞ —Å—Å—ã–ª–æ–∫)
                with open('seen_bodies.txt', 'r') as f:
                    seen = set(line.strip() for line in f)
                
                with open('current_source.txt', 'r', encoding='utf-8') as f:
                    lines = f.readlines()
                
                total_in_url = len(lines)
                added_from_url = 0
                
                with open('temp.txt', 'a', encoding='utf-8') as out, open('seen_bodies.txt', 'a', encoding='utf-8') as seen_file:
                    for line in lines:
                        clean_line = line.strip()
                        if not clean_line or not clean_line.lower().startswith(protocols):
                            continue
                        
                        # –¢–≤–æ—è –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Ç–µ–ª–æ –∏ –∏–º—è
                        if '#' in clean_line:
                            body, remarks = clean_line.split('#', 1)
                        else:
                            body, remarks = clean_line, None
                        
                        body_clean = ''.join(body.split())
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —ç—Ç–æ —Ç–µ–ª–æ —É–∂–µ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ (–∏–∑ —ç—Ç–æ–π –∏–ª–∏ –ø—Ä–æ—à–ª—ã—Ö —Å—Å—ã–ª–æ–∫)
                        if body_clean not in seen:
                            seen.add(body_clean)
                            seen_file.write(body_clean + '\n')
                            final_line = f'{body_clean}#{remarks}' if remarks else body_clean
                            out.write(final_line + '\n')
                            added_from_url += 1
                
                print(f'üîó –°—Å—ã–ª–∫–∞: {sys.argv[1]}')
                print(f'   –ù–∞–π–¥–µ–Ω–æ: {total_in_url} | –î–æ–±–∞–≤–ª–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: {added_from_url}')
            except Exception as e:
                print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {sys.argv[1]}: {e}')
            " "$url"
          done < urls.txt

          # –î–∞–ª–µ–µ —Ç–≤–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —á–∞—Å—Ç–∏ –∏ —Ç.–¥.)
          TOTAL_LINES=$(wc -l < temp.txt 2>/dev/null || echo "0")
          echo "–§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö: $TOTAL_LINES"

          MIN_LINES=1000
          MAX_FILES=10

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–µ —Å–º–µ—à–∞–ª–∏—Å—å
          rm -f file_*.txt

          if [ "$TOTAL_LINES" -le "$MIN_LINES" ]; then
            # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –º–∞–ª–æ ‚Äî –æ–¥–Ω–∞ —á–∞—Å—Ç—å
            cp temp.txt file_aa.txt
            echo "parts=aa" >> $GITHUB_OUTPUT
          else
            # –°—á–∏—Ç–∞–µ–º, –Ω–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π –±–∏—Ç—å (–Ω–µ –±–æ–ª–µ–µ 10)
            NUM_FILES=$(( (TOTAL_LINES + MIN_LINES - 1) / MIN_LINES ))
            if [ "$NUM_FILES" -gt "$MAX_FILES" ]; then NUM_FILES="$MAX_FILES"; fi
    
            # –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: 
            # split -n l/10 —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ä–æ–≤–Ω–æ –Ω–∞ 10 —á–∞—Å—Ç–µ–π –ø–æ —Å—Ç—Ä–æ–∫–∞–º –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞
            split -n "l/$NUM_FILES" --additional-suffix=.txt temp.txt file_
    
            parts=()
            for f in file_*.txt; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
              if [ -s "$f" ]; then
                p="${f#file_}"
                p="${p%.txt}"
                parts+=("$p")
              fi
            done
            echo "parts=$(IFS=,; echo "${parts[*]}")" >> $GITHUB_OUTPUT
          fi


          
      - name: Set Matrix
        id: set-matrix
        run: |
          # –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É
          IFS=',' read -ra PARTS <<< "${{ steps.prepare.outputs.parts }}"
          MATRIX='{"part":['
          for i in "${!PARTS[@]}"; do
            if [ $i -gt 0 ]; then
              MATRIX+=","
            fi
            MATRIX+="\"${PARTS[$i]}\""
          done
          MATRIX+=']}'
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Upload Parts
        uses: actions/upload-artifact@v4
        with:
          name: proxy-parts
          path: file_*.txt
          retention-days: 1

  check-proxies:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: ${{ fromJson(needs.prepare.outputs.matrix).part }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Part
        uses: actions/download-artifact@v4
        with:
          name: proxy-parts
          path: .

      - name: Download and Prepare xray-knife
        run: |
          curl -L "https://github.com/lilendian0x00/xray-knife/releases/download/v8.0.0/Xray-knife-linux-64.zip" -o xray-knife.zip
          unzip -o xray-knife.zip xray-knife
          chmod +x xray-knife

      - name: Run check
        run: |
          FILE="file_${{ matrix.part }}.txt"
          OUT="vless_${{ matrix.part }}.txt"
          
          echo "Working on $FILE"
          
          if [ -f "$FILE" ]; then
            ./xray-knife http -f "$FILE" -o "$OUT" -u http://google.com/generate_204 -z xray -e -d 10000 -t 300 < /dev/null || true
          else
            echo "Error: $FILE not found!"
          fi
          
          [ ! -f "$OUT" ] && touch "$OUT"
          echo "Resulting lines in $OUT: $(wc -l < $OUT)"

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.part }}
          path: "vless_*.txt"
          retention-days: 1

  merge-and-push:
    needs: check-proxies
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: results-*
          merge-multiple: true

      - name: Merge Results
        run: |
          grep -h -v '^$' vless_*.txt > configs.txt 2>/dev/null || touch configs.txt
          echo "Final count: $(wc -l < configs.txt)"

      - name: Push to Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add configs.txt
          if ! git diff --staged --quiet; then
            git commit -m "Update proxies: $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main || git pull --rebase origin master
            git push origin HEAD
          fi

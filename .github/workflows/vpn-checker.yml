name: vpn-checker
on:
  repository_dispatch:
    types: [vpn-checker]
  workflow_dispatch:           
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Proxy List
        id: prepare
        run: |
          chmod +x .github/scripts/prepare-proxy-list.sh
          .github/scripts/prepare-proxy-list.sh
          cat parts_output.txt >> $GITHUB_OUTPUT          
   
      - name: Set Matrix
        id: set-matrix
        run: |
          - name: Set Matrix
            id: set-matrix
            run: |
              chmod +x .github/scripts/generate-matrix.sh
              MATRIX=$( .github/scripts/generate-matrix.sh "${{ steps.prepare.outputs.parts }}" )
              echo "$MATRIX" >> $GITHUB_OUTPUT
    
      - name: Upload Parts
        uses: actions/upload-artifact@v4
        with:
           name: proxy-parts
           path: file_*.txt
           retention-days: 1

  check-proxies:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: ${{ fromJson(needs.prepare.outputs.matrix).part }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Part
        uses: actions/download-artifact@v4
        with:
          name: proxy-parts
          path: .

      - name: Setup xray-knife
        run: |
          chmod +x .github/scripts/setup-xray.sh
          .github/scripts/setup-xray.sh
          
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.part }}
          path: "vless_*.txt"
          retention-days: 1

  merge-and-push:
    needs: check-proxies
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: results-*
          merge-multiple: true

      - name: Merge Results
        run: |
          grep -h -v '^$' vless_*.txt > configs.txt 2>/dev/null || touch configs.txt
          echo "Final count: $(wc -l < configs.txt)"

      - name: Push to Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add configs.txt
          if ! git diff --staged --quiet; then
            git commit -m "Update proxies: $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main || git pull --rebase origin master
            git push origin HEAD
          fi
